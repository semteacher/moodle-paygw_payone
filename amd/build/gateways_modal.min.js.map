{"version":3,"file":"gateways_modal.min.js","sources":["../src/gateways_modal.js"],"sourcesContent":["/* eslint-disable max-len */\n/* eslint-disable no-unused-vars */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for PayUnity content in the gateways modal.\n *\n * @module     paygw_payunity/gateway_modal\n * @copyright  2022 Wunderbyte Gmbh <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Repository from './repository';\nimport Templates from 'core/templates';\nimport Truncate from 'core/truncate';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Creates and shows a modal that contains a placeholder.\n *\n * @returns {Promise<Modal>}\n */\nconst showModalWithPlaceholder = async() => {\n    const modal = await ModalFactory.create({\n        body: await Templates.render('paygw_payunity/payunity_button_placeholder', {})\n    });\n    modal.show();\n    return modal;\n};\n\n/**\n * Process the payment.\n *\n * @param {string} component Name of the component that the itemId belongs to\n * @param {string} paymentArea The area of the component that the itemId belongs to\n * @param {number} itemId An internal identifier that is used by the component\n * @param {string} description Description of the payment\n * @returns {Promise<string>}\n */\nexport const process = (component, paymentArea, itemId, description) => {\n    return Promise.all([\n        showModalWithPlaceholder(),\n        Repository.getConfigForJs(component, paymentArea, itemId),\n    ])\n    .then(([modal, payunityConfig]) => {\n        if (payunityConfig.purchaseid === null) {\n        return Promise.all([\n            modal, payunityConfig\n        ]\n        );\n        } else {\n        return Promise.all([\n            modal,\n            payunityConfig,\n            loadSdk(payunityConfig.purchaseid, payunityConfig.environment, payunityConfig.language),\n        ]);\n         }\n    })\n    .then(([modal, payunityConfig]) => {\n\n        if (payunityConfig.purchaseid === null) {\n\n            require(['jquery'], function($) {\n                require(['core/str'], function(str) {\n\n                    var strings = [\n                        {\n                            key: 'error',\n                            component: 'paygw_payunity'\n                        },\n                        {\n                            key: 'payment_error',\n                            component: 'paygw_payunity',\n                        },\n                        {\n                            key: 'proceed',\n                            component: 'paygw_payunity',\n                        }\n                    ];\n                    var localStrings = str.get_strings(strings);\n                    $.when(localStrings).done(function(localizedEditStrings) {\n                        ModalFactory.create({\n                            type: ModalFactory.types.CANCEL,\n                            title: localizedEditStrings[0],\n                            body: localizedEditStrings[1],\n                            buttons: {\n                                cancel: localizedEditStrings[2],\n                            },\n                        })\n                        .then(function(modal) {\n                            var root = modal.getRoot();\n                            // eslint-disable-next-line max-nested-callbacks\n                            root.on(ModalEvents.cancel, function() {\n                                location.href = payunityConfig.rooturl;\n                            });\n                            modal.show();\n                            return '';\n                        }).catch({\n                            // eslint-disable-next-line no-console\n                            // console.log(e);\n                        });\n                    });\n\n                    });\n            });\n        } else {\n       const form = document.createElement('form');\n       const resourcePath = `/v1/checkouts/${payunityConfig.purchaseid}/payment`;\n       const url = `${payunityConfig.rooturl}/payment/gateway/payunity/checkout.php?resourcepath=${resourcePath}&itemid=${itemId}&orderid=${payunityConfig.purchaseid}&component=${component}&paymentarea=${paymentArea}`;\n       form.setAttribute('action', url);\n       form.classList.add('paymentWidgets');\n       form.setAttribute('data-brands', \"EPS VISA MASTER\");\n       form.setAttribute('merchantTransactionId', \"test123\");\n        modal.setBody(form);\n        return '';\n        }\n        return '';\n    }).then(x => {\n        const promise = new Promise(resolve => {\n            window.addEventListener('onbeforeunload', (e) => {\n                promise.resolve();\n            });\n        });\n        return promise;\n    });\n};\n\n/**\n * Returns Form\n * @param {string} purchaseid Purchase Id\n * @param {string} environment Environment\n * @param {string} language Session language\n * @returns {Promise}\n */\nconst loadSdk = (purchaseid, environment, language) => {\n    let base = '';\n    if (environment === 'sandbox') {\n    base = 'https://eu-test.oppwa.com/';\n    } else {\n    base = 'https://eu-prod.oppwa.com/';\n    }\n    const sdkUrl = `${base}v1/paymentWidgets.js?checkoutId=${purchaseid}`;\n\n    // Check to see if this file has already been loaded. If so just go straight to the func.\n    if (loadSdk.currentlyloaded === sdkUrl) {\n        return Promise.resolve();\n    }\n\n    if (loadSdk.currentlyloaded) {\n        const suspectedScript = document.querySelector(`script[src=\"${loadSdk.currentlyloaded}\"]`);\n        if (suspectedScript) {\n            suspectedScript.parentNode.removeChild(suspectedScript);\n        }\n    }\n\n    const script = document.createElement('script');\n\n    return new Promise(resolve => {\n        if (script.readyState) {\n            script.onreadystatechange = function() {\n                if (this.readyState == 'complete' || this.readyState == 'loaded') {\n                    this.onreadystatechange = null;\n                    resolve();\n                }\n            };\n        } else {\n            script.onload = function() {\n                resolve();\n            };\n        }\n\n        script.setAttribute('src', sdkUrl);\n        const optionscript = document.createElement('script');\n        optionscript.type = 'text/javascript';\n        const lang = language;\n        const code = `var wpwlOptions = { locale: '${lang}'}`;\n        optionscript.appendChild(document.createTextNode(code));\n        document.head.appendChild(optionscript);\n        document.head.appendChild(script);\n        loadSdk.currentlyloaded = sdkUrl;\n    });\n};\n\n/**\n * Holds the full url\n *\n * @static\n * @type {string}\n */\n loadSdk.currentlyloaded = '';\n"],"names":["showModalWithPlaceholder","async","modal","ModalFactory","create","body","Templates","render","show","component","paymentArea","itemId","description","Promise","all","Repository","getConfigForJs","then","_ref","payunityConfig","purchaseid","loadSdk","environment","language","_ref2","form","document","createElement","resourcePath","url","rooturl","setAttribute","classList","add","setBody","require","$","str","localStrings","get_strings","key","when","done","localizedEditStrings","type","types","CANCEL","title","buttons","cancel","getRoot","on","ModalEvents","location","href","catch","x","promise","resolve","window","addEventListener","e","base","sdkUrl","currentlyloaded","suspectedScript","querySelector","parentNode","removeChild","script","readyState","onreadystatechange","this","onload","optionscript","code","appendChild","createTextNode","head"],"mappings":";;;;;;;4NAqCMA,yBAA2BC,gBACvBC,YAAcC,uBAAaC,OAAO,CACpCC,WAAYC,mBAAUC,OAAO,6CAA8C,aAE/EL,MAAMM,OACCN,wBAYY,CAACO,UAAWC,YAAaC,OAAQC,cAC7CC,QAAQC,IAAI,CACfd,2BACAe,WAAWC,eAAeP,UAAWC,YAAaC,UAErDM,MAAKC,WAAEhB,MAAOiB,4BACuB,OAA9BA,eAAeC,WACZP,QAAQC,IAAI,CACfZ,MAAOiB,iBAIJN,QAAQC,IAAI,CACfZ,MACAiB,eACAE,QAAQF,eAAeC,WAAYD,eAAeG,YAAaH,eAAeI,eAIrFN,MAAKO,YAAEtB,MAAOiB,yBAEuB,OAA9BA,eAAeC,WA6CZ,OACFK,KAAOC,SAASC,cAAc,QAC9BC,qCAAgCT,eAAeC,uBAC/CS,cAASV,eAAeW,uEAA8DF,gCAAuBjB,2BAAkBQ,eAAeC,iCAAwBX,kCAAyBC,oBACrMe,KAAKM,aAAa,SAAUF,KAC5BJ,KAAKO,UAAUC,IAAI,kBACnBR,KAAKM,aAAa,cAAe,mBACjCN,KAAKM,aAAa,wBAAyB,WAC1C7B,MAAMgC,QAAQT,MACP,UApDHU,QAAQ,CAAC,WAAW,SAASC,GACzBD,QAAQ,CAAC,aAAa,SAASE,SAgBvBC,aAAeD,IAAIE,YAdT,CACV,CACIC,IAAK,QACL/B,UAAW,kBAEf,CACI+B,IAAK,gBACL/B,UAAW,kBAEf,CACI+B,IAAK,UACL/B,UAAW,oBAInB2B,EAAEK,KAAKH,cAAcI,MAAK,SAASC,6CAClBvC,OAAO,CAChBwC,KAAMzC,uBAAa0C,MAAMC,OACzBC,MAAOJ,qBAAqB,GAC5BtC,KAAMsC,qBAAqB,GAC3BK,QAAS,CACLC,OAAQN,qBAAqB,MAGpC1B,MAAK,SAASf,cACAA,MAAMgD,UAEZC,GAAGC,sBAAYH,QAAQ,WACxBI,SAASC,KAAOnC,eAAeW,WAEnC5B,MAAMM,OACC,MACR+C,MAAM,aAmBlB,MACRtC,MAAKuC,UACEC,QAAU,IAAI5C,SAAQ6C,UACxBC,OAAOC,iBAAiB,kBAAmBC,IACvCJ,QAAQC,uBAGTD,iBAWTpC,QAAU,CAACD,WAAYE,YAAaC,gBAClCuC,KAAO,GAEXA,KADoB,YAAhBxC,YACG,6BAEA,mCAEDyC,iBAAYD,gDAAuC1C,eAGrDC,QAAQ2C,kBAAoBD,cACrBlD,QAAQ6C,aAGfrC,QAAQ2C,gBAAiB,OACnBC,gBAAkBvC,SAASwC,oCAA6B7C,QAAQ2C,uBAClEC,iBACAA,gBAAgBE,WAAWC,YAAYH,uBAIzCI,OAAS3C,SAASC,cAAc,iBAE/B,IAAId,SAAQ6C,UACXW,OAAOC,WACPD,OAAOE,mBAAqB,WACD,YAAnBC,KAAKF,YAA+C,UAAnBE,KAAKF,kBACjCC,mBAAqB,KAC1Bb,YAIRW,OAAOI,OAAS,WACZf,WAIRW,OAAOtC,aAAa,MAAOgC,cACrBW,aAAehD,SAASC,cAAc,UAC5C+C,aAAa9B,KAAO,wBAEd+B,4CADOpD,eAEbmD,aAAaE,YAAYlD,SAASmD,eAAeF,OACjDjD,SAASoD,KAAKF,YAAYF,cAC1BhD,SAASoD,KAAKF,YAAYP,QAC1BhD,QAAQ2C,gBAAkBD,WAUjC1C,QAAQ2C,gBAAkB"}